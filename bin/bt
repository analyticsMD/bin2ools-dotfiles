#!/usr/bin/env /usr/local/bin/bash

. <(~/.bt/utils/path -s 2>/dev/null)  # find a better path. 

export BT="${HOME}/.bt"               # expand your thinkscape.

. ${BT}/settings                      # set a goal.

map_tools                             # grab some tools.

# expose a list of installed tools and toolsets. 

shopt -s expand_aliases

tmppath="$(echo $(gmktemp))"

{
    SRC="$(dirname "$(echo "${PATH}"        | \
           perl -pe 's/:/\n/g'              | \
           grep -E 'devops|aws)-sso-util\/' | \
           grep '\/b2'                      | \
           perl -pe 's/^\/Users\/[\w_\-+]+(.*)/\$\{HOME\}\1/' | \
           head -n 1 )"                       \
    )"
    echo -ne "export SRC=\"${SRC}\"\n\n"

    declare -a features=( "generate" "complete" "local" ) 

    . <(${HOME}/.bt/utils/path -s 2>/dev/null) 
    for ds in $( echo "${PATH}" | perl -pe 's/:/\n/g' | grep '\/b2'); do  
        
        ts="$(basename ${ds})"            # toolset
        t="$(echo ${ts} | perl -pe 's/^b2//')"  # tool
        #echo tool: ${t} toolset: ${ts}

        for f in ${features[@]}; do 
            [[ "${f}" == "complete" ]] && s="source " || s=""
            echo -ne "${t}_${f}() { ${s}\${SRC}/${ts}/${t}_${f} \${@} ;}\n\n"
            echo -ne "declare -fx ${t}_${f}\n\n"
        done

        echo -ne ln -fs \${SRC}/${ts}/${t}_local "${HOME}/.local/bin/${t}\n\n"
        echo -ne "${t}_complete\n\n"
    done
    
} > "${tmppath}"


source "${tmppath}"
#cat "${tmppath}"
rm "${tmppath}"
