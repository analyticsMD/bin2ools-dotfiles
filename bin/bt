#!/usr/bin/env /usr/local/bin/bash

. <(~/.bt/utils/path -s 2>/dev/null)  # find a better path. 
good="$(echo "${PATH}" | perl -pe 's/:/\n/g' | grep '\/b2' | wc -l)"
[[ -n "${good}" ]] && { 
    echo -e "You have ${CYAN}${good}${NC} bintools installed."
} || {  
    echo -e "${YELLOW}\$PATH${NC} is stale.\nPlease rerun the path tool."
}

export BT="${HOME}/.bt"               # expand your thinkscape.
. ${BT}/settings                      # set a goal.
#map_tools                             # grab some tools.

# expose a list of installed tools and toolsets. 

shopt -s expand_aliases

tmppath="$(echo $(gmktemp))"



source <({

    SRC="$(dirname "$(echo "${PATH}"        | \
           perl -pe 's/:/\n/g'              | \
           grep -E 'devops|aws)-sso-util\/' | \
           grep '\/b2'                      | \
           perl -pe 's/^\/Users\/[\w_\-+]+(.*)/\$\{HOME\}\1/' | \
           head -n 1 )"                       \
    )"
    echo -ne "export SRC=\"${SRC}\"\n\n"

    declare -a features=( "generate" "complete" "local" ) 

    . <(${HOME}/.bt/utils/path -s 2>/dev/null) 

    for ds in $( echo "${PATH}" | perl -pe 's/:/\n/g' | grep '\/b2'); do  
        
        ts="$(basename ${ds})"            # toolset
        t="$(echo ${ts} | perl -pe 's/^b2//')"  # tool
        #echo tool: ${t} toolset: ${ts}

        for f in ${features[@]}; do 
            [[ "${f}" == "complete" ]] && s="source " || s=""

            echo -ne "${t}_${f}() { ${s}${SRC}/${ts}/${t}_${f} \${@} ;}\n\n"
            echo -ne "declare -fx ${t}_${f}\n\n"
            
            echo -ne ln -fs ${SRC}/${ts}/${t}_${f} "\${HOME}/.local/bin/${t}_${f}\n\n"
        done

        echo -ne ln -fs ${SRC}/${ts}/${t}_${f} "\${HOME}/.local/bin/${t}\n\n"


        echo -ne "${t}() { ${SRC}/${ts}/${t}_local \${@} ;}\n\n"
        echo -ne "declare -fx ${t}\n"
        echo -ne "declare -fx ${t}_complete\n"
        echo -ne "${t}_complete\n\n"


    done
    

}) > "${tmppath}"

#cat "${tmppath}"

source "${tmppath}"


# explicitly exec the exported functions
# By the time we get here there are already
# exported in the BASH env. 
#. <(${HOME}/.local/bin/ssm_complete)
#. <(${HOME}/.local/bin/rds_complete)

get_src_dir 
rds_complete
ssm_complete

#rm "${tmppath}"

