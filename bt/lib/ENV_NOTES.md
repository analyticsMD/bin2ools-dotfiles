
#env_aws

#gen_bt_config
#regen_creds
#tmppath="$(gmktemp -p ${HOME}/tmp rds_map.XXXXXXXXXXXX)"

#cat $j | jq '.account | to_entries[] | select(.value|tonumber) | "\(.value)"'

# -------------------------------------------------------------
# Mini-API
# -------------------------------------------------------------

# special mask function, for generators.
# So that they write files securely. 

umask_on() { 
  umask 0077
}

umask_off() {
  umask 0022
}



#
#  [[ -z "${add}"  ]] && return 1
#  [[ -z "${THIS}" ]] && return 2

#  _PATH=${PATH}

#  case ":$_PATH:" in
#    *":$THIS:"*) return;; # already exists
#  esac

#  case $add in
#    -p ) _NEW=":${THIS}:${_PATH}:" ;;
#    -a ) _NEW=":${_PATH}:${THIS}:" ;;
#    -r ) ;;
#    * ) return 3 ;;
#  esac

#  _NEW=$(echo $_NEW | perl -pe 's/::/:/g; s/\/\//\//g; s/:$//; s/^://')
#  export PATH=${_NEW}
#}

#export -f path_edit

#path_dedupe () { 
#  _PATH=${1:-${PATH}}
#  THIS="$(printf '%s:' $(echo -ne ${_PATH}) | \
#  awk -v RS=: -v ORS=: '!arr[$0]++' |\
#  sed -e 's/^?[\s:\n]*$?//; s/[:]+/[:]/g; s/:$//; s/^://;')"
#  echo $THIS
#  declare -x PATH="${THIS}"
#} 

#path_set () { THIS=${1:-${PATH}}; export PATH=${THIS} ;} 

# Build a clean path from existing ENV, 
# using path groupings, and deduping.
# check path for dupes.  repath if true.
#repath() { 
#  path_set "$(path_dedupe "${PATH}")"
#} 

#repath  # rebuild path #echo path_dedupe ${PATH}

## ----------------------------------------------------------------
## AWS SETTINGS
## ----------------------------------------------------------------
## Qventus has a lot of infrastructure in AWS. This library
## contains streamlining functions to make that environment
## easier to work with. 


# ----------------------------------------------------------------
# variables that define the behavior of aws-vault backend secrets. 
# Qventus uses aws-vault to encrypt credentials at rest on laptops, 
# ecs, and ec2 hosts.  This is specifically to remove any long term 
# credentials stored in the clear on laptops, etc. 

# Lowest maintenance alternative is the 'file' option, which uses 
# encrypted flat files in the aws-vault file space.
# export AWS_VAULT_FILE_PASSPHRASE=(autogenerated-password)

# The autogenerated password frees you from the need to type 
# regular passwords to unlock your credentials.  Instead, a randomly 
# generated password is created with each 8h session, and loaded
# into this variable. This makes the password a 'throw-away' credential,
# not unlike the temporary session tokens deployed by AWS.

# Other useful var (not currently implemented).
# See flag: --backend
# AWS_VAULT_BACKEND=file
# See flags--prompt
# AWS_VAULT_PROMPT=terminal

# AWS_ROLE_ARN: ARN of IAM role in the active profile
# AWS_ROLE_SESSION_NAME: name of the role session in the active profile

# AWS_STS_REGIONAL_ENDPOINTS: must be "regional" or "legacy"
# AWS_MFA_SERIAL: id number of MFA device. We do not need this, as we 
#                 use Okta for MFA before Federated Authentication. 

# TTLs for sessions:
# AWS_SESSION_TOKEN_TTL:         8h
# AWS_CHAINED_SESSION_TOKEN_TTL: 1h
# AWS_ASSUME_ROLE_TTL:           1h 
# AWS_FEDERATION_TOKEN_TTL:     12h
# AWS_MIN_TTL:                   5m

# Comma separated key-value list of tags passed with the 
# AssumeRole call, overrides session_tags profile config variable.
# AWS_SESSION_TAGS: 

# Comma separated list of transitive tags. 
# Overrides transitive_session_tags profile config variable
# AWS_TRANSITIVE_TAGS: 

# We currently do not support the macos keychain or pass options
# for credential protection on the local host.  We might someday, 
# and if you really want them, you can manage your own configs. 

# AWS_VAULT_KEYCHAIN_NAME: Name of macOS keychain to use (see the flag --keychain)
# AWS_VAULT_PASS_PASSWORD_STORE_DIR: Pass password store directory (see the flag --pass-dir)
# AWS_VAULT_PASS_CMD: Name of the pass executable (see the flag --pass-cmd)
# AWS_VAULT_PASS_PREFIX: Prefix to prepend to the item path stored in pass (see the flag --pass-prefix)


 
#aws_defaults


   # Other useful var (not currently implemented).
   # See flag: --backend
   # AWS_VAULT_BACKEND=file
   # See flags--prompt
  # AWS_VAULT_PROMPT=terminal


## ----------------------------------------------------------------
## AWS SETTINGS
## ----------------------------------------------------------------
# Save secrets history in ssm, via chamber. 
# once saved, create a new password, and then 
# migrate aws-vault creds to a new file.
# (There are only one or two per person.)
# Then change the password. Script should 
# log this in the background.
# 
aws_vault_rotate() {
  # generate new secret. 
  s=$(openssl rand -base64 40 | colrm 27)
  # update backend.
   
  # update secret.
  declare -x AWS_VAULT_FILE_PASSPHRASE=$s
} 

# 
# USAGE: 
# path_edit -p /this/path (prepends to $PATH)
# path_edit -a /that/path (appends to $PATH)
# path_edit -r /unwanted/path (removes from $PATH)
#path_edit() {
#  add=${1:-""}
#  THIS=$(echo -ne ${2:-""} | perl -pe 's/\s*//g')

# source routines.
/Users/marc/local/bin/lib/bt_env
