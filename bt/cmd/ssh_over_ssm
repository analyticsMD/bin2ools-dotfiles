#!/usr/bin/env /usr/local/bin/bash

BT=${HOME}/.bt
. ${BT}/lib/bt
. ${BT}/src/inst_map.src

autologin 

# ssh connectivity over ssm
# -------------------------
# Required: Run all generators first.
# This will produce the necessary files 
# for an up-to-date run. 
#
# Generators required
# -------------------
# ssh_over_ssm.gen 
#
# Generated files required
# --------------------------
# ssh_over_ssm.src, ssh_over_ssm.cmpl
#  
host=${1:-NONE}

[[ "$host" == "NONE" ]] && echo "Usage: ssh_over_ssm <host>" && exit 1

# sources a list of hostnames and instance_ids. 
# Queries aws for a list of all instances.
# Caches them as an associative array in a
# local file in the generate.d dir.
#
#cache_inst

#to_debug $(declare -p inst_map)
#to_debug echo host: ${inst_map[$host]}

target=$(echo ${inst_map[$host]} | awk -F, '{print $2}') 

[[ -z "${target}" ]] && \
echo "FATAL: Cannot find host record for: ${host}" \
&& exit 1

echo "starting ssh_over_ssm connection to $host (aka $target) ... "
#aws ssm start-session --target ${target}
ssh -F ${BT}/cfg/ssh_over_ssm.conf ${1}
